[% USE scalar -%]
[% PROCESS "macro_general.html" -%]
[% WRAPPER "layout.html" %]

<h1>
    WORF Thumbnails for
    [% IF projectid.defined %]
        Project [% projectid %],
    [% END %]
    [% ut_date.ymd %]
</h1>

[% UNLESS projectid.defined %]
    [% render_date_select(target_base, ut_date, {telescope => telescope}, '') %]
[% ELSE %]
    <form method="get" action="[% target_base %]">
        <p>
            <select name="inccal">
                <option [% IF ! inccal %]selected="selected"[% END %] value="0">Excluding calibrations</option>
                <option [% IF inccal %]selected="selected"[% END %] value="1">With calibrations</option>
            </select>
            <input type="submit" name="" value="View" />
            [% render_hidden_fields({project => projectid, utdate => ut_date.ymd, telescope => telescope}) %]
        </p>
    </form>
[% END %]

[% MACRO render_thumbnails(previews) BLOCK %]
    [% IF previews.size > 0 %]
        [% FOR preview IN previews %]
            <a href="[% target_obs | html %]inst=[% preview.instrument | html %]&runnr=[% preview.runnr | html %]#[% preview.filename_no_size_ext | html %]"><img src="[% target_image | html %]filename=[% preview.filename %]&amp;md5sum=[% preview.md5sum | html %]" width="64" height="64" alt="[% preview.suffix | html %]" /></a>
        [% END %]
    [% ELSE %]
        &mdash;
    [% END %]
[% END %]

<table class="bordered topalign">
    <tr>
        <th rowspan="2">Inst.</th>
        <th rowspan="2">Obs.</th>
        <th rowspan="2">Information</th>
        <th rowspan="2">Subsys.</th>
        <th colspan="2">Preview images</th>
    </tr>
    <tr>
        <th>Observation</th>
        <th>Group</th>
    </tr>
    [% FOREACH obs IN observations %]
        [% SET subsystems = obs.scalar.subsystems_tiny %]
        [% SET num_rows = subsystems.size %]
        [% FOREACH ss IN subsystems %]
            <tr>
                [% IF loop.first %]
                    <td rowspan="[% num_rows %]">[% obs.instrument | html %]</td>
                    <td rowspan="[% num_rows %]">
                        <a href="[% target_obs | html %]inst=[% obs.instrument | html %]&runnr=[% obs.runnr | html %]">[% obs.runnr | html %]</a>
                    </td>
                    <td rowspan="[% num_rows %]" class="[% status_class.item(obs.status) %]">
                        [% IF obs.projectid.defined %]
                            <a href="/cgi-bin/projecthome.pl?project=[% obs.projectid | uri %]">[% obs.projectid | html %]</a>
                        [% ELSE %]
                            Unknown project
                        [% END %]
                        [% IF obs.target.defined %]
                            <br />[% obs.target | html %]
                        [% END %]
                        [% IF obs.mode.defined %]
                            <br />[% obs.mode | html %]
                        [% END %]
                        <br />[% status_label.item(obs.status) | html %]
                    </td>
                [% END %]
                <td class="[% status_class.item(obs.status) %]">
                    [% IF ss.subsystem_number.defined %]
                        [% ss.subsystem_number | html %]
                    [% ELSIF ss.filter.defined %]
                        [% ss.filter | html %]
                    [% ELSE %]
                        &nbsp;
                    [% END %]
                </td>
                <td>
                    [% render_thumbnails(ss.previews_sorted({group => 0})) %]
                </td>
                <td>
                    [% render_thumbnails(ss.previews_sorted({group => 1})) %]
                </td>
            </tr>
        [% END %]
    [% END %]
</table>
[% END %]
